<div class="experiment-lineage-container">
  <!-- Header with controls -->
  <div class="lineage-header">
    <h3>Model Lineage</h3>
    <div class="lineage-controls">
      <button
        mat-stroked-button
        (click)="toggleFilterChanged()"
        [class.active]="filterChangedOnly()">
        <mat-icon>filter_list</mat-icon>
        Show Changes Only
      </button>
      <button
        mat-stroked-button
        (click)="toggleMetrics()">
        <mat-icon>{{showMetrics() ? 'visibility_off' : 'visibility'}}</mat-icon>
        {{showMetrics() ? 'Hide' : 'Show'}} Metrics
      </button>
    </div>
  </div>

  <!-- Loading state -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading lineage data...</p>
    </div>
  }

  <!-- Empty state -->
  @if (!loading() && graphData().nodes.length === 0) {
    <div class="empty-state">
      <mat-icon>account_tree</mat-icon>
      <p>No lineage data available</p>
      <small>This experiment has no parent or child tasks</small>
    </div>
  }

  <!-- Graph Visualization -->
  @if (!loading() && graphData().nodes.length > 0) {
    <div class="graph-container">
      <ngx-graph
        class="lineage-graph"
        [nodes]="graphData().nodes"
        [links]="graphData().links"
        [clusters]="graphData().clusters"
        [curve]="curve"
        layout="dagreCluster"
        [layoutSettings]="layoutSettings"
        [autoZoom]="true"
        [autoCenter]="true"
        [panOnZoom]="true"
        [enableZoom]="true"
        [zoomSpeed]="0.1"
        [minZoomLevel]="0.1"
        [maxZoomLevel]="4.0"
        [panningEnabled]="true"
        (select)="onNodeSelect($event)">

        <!-- Custom node template -->
        <ng-template #nodeTemplate let-node>
          <svg:foreignObject
            [attr.width]="260"
            [attr.height]="180"
            [attr.x]="-130"
            [attr.y]="-90">
            <xhtml:div class="node-wrapper">
              <sm-lineage-node
                [node]="node.data"
                [selected]="selectedNode()?.id === node.data?.id"
                [showMetrics]="showMetrics()"
                [highlightChanges]="filterChangedOnly()"
                (nodeClick)="selectNode(node.data)"
                (navigateClick)="navigateToTask(node.data?.taskId)">
              </sm-lineage-node>
            </xhtml:div>
          </svg:foreignObject>
        </ng-template>

        <!-- Custom link template -->
        <ng-template #linkTemplate let-link>
          <svg:g class="edge">
            <svg:path
              class="line"
              [attr.d]="link.line"
              stroke-width="2"
              fill="none"
              [class.selected]="selectedNode()?.id === link.source || selectedNode()?.id === link.target">
            </svg:path>
            @if (link.label) {
              <svg:text class="edge-label" text-anchor="middle">
                {{link.label}}
              </svg:text>
            }
          </svg:g>
        </ng-template>

      </ngx-graph>
    </div>
  }
</div>
